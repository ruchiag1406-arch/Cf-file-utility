image: atlassian/default-image:3

pipelines:
  default:
    - step:
        name: Deploy to Amazon ECS
        services:
          - docker
        caches:
          - docker
        script:
          # 1️⃣ Configure AWS credentials
          - export AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
          - export AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
          - export AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION}

          # 2️⃣ Login to Amazon ECR
          - aws ecr get-login-password --region ${AWS_DEFAULT_REGION} | docker login --username AWS --password-stdin ${ECR_ACCOUNT_ID}.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com

          # 3️⃣ Generate unique Docker tag (git sha + timestamp)
          - IMAGE_TAG=$(git rev-parse --short HEAD)-$(date +%Y%m%d%H%M%S)

          # 4️⃣ Build Docker image
          - docker build -t ${ECR_REPO_NAME}:${IMAGE_TAG} .

          # 5️⃣ Tag image with unique tag
          - docker tag ${ECR_REPO_NAME}:${IMAGE_TAG} ${ECR_ACCOUNT_ID}.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com/${ECR_REPO_NAME}:${IMAGE_TAG}

          # 6️⃣ Tag same image as latest
          - docker tag ${ECR_REPO_NAME}:${IMAGE_TAG} ${ECR_ACCOUNT_ID}.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com/${ECR_REPO_NAME}:latest

          # 7️⃣ Push images to ECR
          - docker push ${ECR_ACCOUNT_ID}.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com/${ECR_REPO_NAME}:${IMAGE_TAG}
          - docker push ${ECR_ACCOUNT_ID}.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com/${ECR_REPO_NAME}:latest

          # 8️⃣ Force ECS service redeployment
          - aws ecs update-service --cluster ${ECS_CLUSTER} --service ${ECS_SERVICE} --force-new-deployment --region ${AWS_DEFAULT_REGION}

definitions:
  services:
    docker:
      memory: 3072

  caches:
    docker: /var/lib/docker
